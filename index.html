<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediktor rojen칤 mravenc콢</title>
    <!-- Nov치 ikona pro kartu prohl칤쬰캜e -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游냎</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #probability-circle {
            transition: background-color 1.5s ease-in-out;
            box-shadow: 
                inset 0px 10px 20px rgba(255, 255, 255, 0.4),
                inset 0px -10px 20px rgba(0, 0, 0, 0.2),
                0px 10px 25px rgba(0, 0, 0, 0.2);
        }
        .parameter-tile {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .parameter-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* Styly pro mod치ln칤 okno */
        #modal-overlay {
            transition: opacity 0.3s ease-in-out;
            z-index: 50;
        }
        #modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-hidden #modal-content {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-white text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md text-center">
        <h1 class="text-3xl font-bold mb-2 text-gray-900">Rojen칤 Mravenc콢</h1>
        <p id="status-message" class="mb-6 text-gray-500 h-6">Z칤sk치v치m data o po캜as칤...</p>

        <!-- Kruh s mravencem -->
        <div id="probability-circle" class="w-64 h-64 sm:w-72 sm:h-72 rounded-full mx-auto mb-8 flex items-center justify-center bg-gray-200">
            <img id="ant-image" src="https://a-extermination.com/wp-content/uploads/2023/04/Exterminateur_de_fourmis_charpentin_res_Carpenter_Ant_Extermination.png" 
                 alt="Obr치zek mravence" 
                 class="h-1/2 w-auto"
                 onerror="this.onerror=null; this.src='https://placehold.co/256x256/ffffff/cccccc?text=Obr%C3%A1zek+nelze+nahr%C3%A1t';">
        </div>

        <!-- Parametry / Manu치ln칤 hled치n칤 - kontejner pro p콏ep칤n치n칤 -->
        <div id="content-container">
            <div id="parameters-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                <!-- Bu켿ky parametr콢 se napln칤 pomoc칤 JS -->
            </div>
            
            <div id="manual-location" class="w-full text-center mt-2 hidden">
                 <p class="text-sm text-gray-600 mb-2">Zadejte nov칠 m칤sto pro anal칳zu:</p>
                <div class="relative">
                    <input type="text" id="city-input" placeholder="Nap콏. Fr칳dlant nad Ostravic칤" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-gray-800" autocomplete="off">
                    <div id="suggestions-box" class="absolute left-0 right-0 bg-white border border-gray-300 rounded-b-lg mt-1 text-left z-10 hidden">
                        <!-- Na코ept치va캜 se napln칤 pomoc칤 JS -->
                    </div>
                </div>
                 <button id="cancel-search-button" class="mt-4 px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Zru코it</button>
            </div>
        </div>

         <button id="refresh-button" class="mt-8 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors">
            Pou쮂셦 moji polohu
        </button>
    </div>
    
    <!-- Mod치ln칤 okno pro vysv캩tlen칤 parametr콢 -->
    <div id="modal-overlay" class="modal-hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold">N치zev parametru</h2>
                <button id="modal-close" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="text-left space-y-4">
                <!-- Obsah se vlo쮂 dynamicky -->
            </div>
        </div>
    </div>


    <script>
        // --- Konfigurace a reference na elementy ---
        const probabilityCircle = document.getElementById('probability-circle');
        const parametersGrid = document.getElementById('parameters-grid');
        const statusMessage = document.getElementById('status-message');
        const refreshButton = document.getElementById('refresh-button');
        const manualLocationSection = document.getElementById('manual-location');
        const cityInput = document.getElementById('city-input');
        const suggestionsBox = document.getElementById('suggestions-box');
        const cancelSearchButton = document.getElementById('cancel-search-button');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        let debounceTimer;

        // Data pro mod치ln칤 okna
        const explanations = {
            location: {
                title: 'Lokalita',
                text: `<p><strong>D콢le쬴tost:</strong> P콏esn치 poloha je kl칤캜ov치 pro z칤sk치n칤 relevantn칤ch a m칤stn칤ch dat o po캜as칤. Kliknut칤m na tuto dla쬯ici m콢쬰te zm캩nit lokalitu.</p><p><strong>Ide치l:</strong> Aplikace pou쮂셨치 data pro zobrazen칠 m캩sto k co nejp콏esn캩j코칤 p콏edpov캩di.</p>`
            },
            month: { title: 'M캩s칤c', text: `<p><strong>D콢le쬴tost:</strong> Rojen칤 mravenc콢 <em>Lasius niger</em> (Mravenec obecn칳) je siln캩 v치z치no na ro캜n칤 obdob칤. D캩je se tak pouze v tepl칳ch letn칤ch m캩s칤c칤ch.</p><p><strong>Ide치l:</strong> Hlavn칤 sez칩na je v 캜ervenci a srpnu. Okrajov캩 se rojen칤 m콢쬰 objevit i na konci 캜ervna a za캜치tkem z치콏칤.</p>`},
            temp: { title: 'Teplota', text: `<p><strong>D콢le쬴tost:</strong> Mravenci jsou studenokrevn칤, tak쬰 pro let pot콏ebuj칤 dostatek tepla z okol칤, ale ne p콏칤li코n칠 horko.</p><p><strong>Ide치l:</strong> Optim치ln칤 teplota pro vzlet se pohybuje mezi <strong>23춿C a 30춿C</strong>.</p>` },
            humidity: { title: 'Vlhkost', text: `<p><strong>D콢le쬴tost:</strong> Vy코코칤 vlhkost vzduchu chr치n칤 jejich k콏칤dla p콏ed vyschnut칤m. Po de코ti je nav칤c p콢da m캩k캜칤, co usnad켿uje kr치lovn치m vyhrab치n칤 nov칠ho hn칤zda.</p><p><strong>Ide치l:</strong> Relativn칤 vlhkost vzduchu nad <strong>65%</strong> je optim치ln칤.</p>` },
            wind: { title: 'V칤tr', text: `<p><strong>D콢le쬴tost:</strong> Siln칳 v칤tr by mravenc콢m znemo쬹il kontrolu letu. Preferuj칤 proto klidn칠, bezv캩trn칠 dny.</p><p><strong>Ide치l:</strong> Bezv캩t콏칤 nebo jen slab칳 v칤tr do <strong>10 km/h</strong>.</p>` },
            rain: { title: 'D칠코콘 v캜era', text: `<p><strong>D콢le쬴tost:</strong> D칠코콘 v p콏edchoz칤m dni je 캜ast칳m spou코t캩캜em. Zm캩k캜칤 p콢du, co je pro kr치lovny 쬴votn캩 d콢le쬴t칠 pro rychl칠 zalo쬰n칤 hn칤zda.</p><p><strong>Ide치l:</strong> Alespo켿 <strong>0.5 mm</strong> sr치쬰k den p콏edem, p콏i캜em den rojen칤 by m캩l b칳t such칳.</p>`}
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', main);
        refreshButton.addEventListener('click', main);
        cityInput.addEventListener('input', (event) => {
            clearTimeout(debounceTimer);
            suggestionsBox.classList.add('hidden');
            const query = event.target.value;
            if (query.length < 3) return;
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });
        
        parametersGrid.addEventListener('click', (event) => {
            const tile = event.target.closest('.parameter-tile');
            if (!tile?.dataset.param) return;
            
            const paramKey = tile.dataset.param;
            if (paramKey === 'location') {
                showSearchView();
            } else if (explanations[paramKey]) {
                const { title, text } = explanations[paramKey];
                modalTitle.textContent = title;
                modalBody.innerHTML = text;
                modalOverlay.classList.remove('modal-hidden');
            }
        });

        cancelSearchButton.addEventListener('click', showParametersView);
        modalClose.addEventListener('click', () => modalOverlay.classList.add('modal-hidden'));
        modalOverlay.addEventListener('click', (event) => { if (event.target === modalOverlay) modalOverlay.classList.add('modal-hidden'); });
        
        function showSearchView() {
            parametersGrid.classList.add('hidden');
            manualLocationSection.classList.remove('hidden');
            cityInput.focus();
        }

        function showParametersView() {
            manualLocationSection.classList.add('hidden');
            parametersGrid.classList.remove('hidden');
            suggestionsBox.classList.add('hidden');
            cityInput.value = '';
        }

        function main() {
            showParametersView();
            statusMessage.textContent = 'Zji코콘uji va코i polohu...';
            parametersGrid.innerHTML = '';
            probabilityCircle.style.backgroundColor = 'hsl(0, 0%, 85%)';

            getUserLocation()
                .then(pos => {
                    statusMessage.textContent = 'Na캜칤t치m data o po캜as칤 a lokalit캩...';
                    return getWeatherDataAndLocation(pos.coords.latitude, pos.coords.longitude);
                })
                .then(data => updateUI(data.probability, data.weather, data.location))
                .catch(error => {
                    console.log(`Handled error: ${error.message}`);
                    statusMessage.innerHTML = `<span class="text-red-500">${error.message}</span>`;
                    showSearchView();
                });
        }
        
        async function fetchSuggestions(query) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&accept-language=cs&featuretype=city,town,village`;
            try {
                const response = await fetch(url);
                if (!response.ok) return;
                const data = await response.json();
                displaySuggestions(data);
            } catch (error) {
                console.error("Chyba p콏i na캜칤t치n칤 n치vrh콢:", error);
            }
        }

        function displaySuggestions(suggestions) {
            if (suggestions.length === 0) {
                suggestionsBox.classList.add('hidden');
                return;
            }
            suggestionsBox.innerHTML = '';
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.textContent = suggestion.display_name;
                div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                div.dataset.lat = suggestion.lat;
                div.dataset.lon = suggestion.lon;
                div.dataset.name = suggestion.display_name.split(',')[0];
                div.addEventListener('click', () => {
                    selectSuggestion(div.dataset.lat, div.dataset.lon, div.dataset.name);
                });
                suggestionsBox.appendChild(div);
            });
            suggestionsBox.classList.remove('hidden');
        }

        async function selectSuggestion(lat, lon, name) {
            statusMessage.textContent = `Na캜칤t치m data pro ${name}...`;
            showParametersView();
            try {
                const data = await getWeatherDataAndLocation(lat, lon, name);
                updateUI(data.probability, data.weather, data.location);
            } catch (error) {
                statusMessage.innerHTML = `<span class="text-red-500">${error.message}</span>`;
            }
        }
        
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolokace nen칤 podporov치na.'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(resolve, (error) => {
                    let message = 'Nezn치m치 chyba polohy.';
                    if (error.code === 1) message = 'P콏칤stup k poloze byl zam칤tnut.';
                    if (error.code === 2) message = 'Informace o poloze nejsou dostupn칠.';
                    if (error.code === 3) message = 'Vypr코el 캜as pro zji코t캩n칤 polohy.';
                    reject(new Error(message));
                }, { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 });
            });
        }

        async function getWeatherDataAndLocation(lat, lon, predefinedLocation = null) {
            const weatherApiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m&daily=precipitation_sum&past_days=1&forecast_days=1`;
            const weatherResponse = await fetch(weatherApiUrl);
            if (!weatherResponse.ok) throw new Error('Chyba p콏i na캜칤t치n칤 po캜as칤.');
            const weatherData = await weatherResponse.json();
            
            let locationName = predefinedLocation;
            if (!locationName) {
                const locationApiUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=cs`;
                const locationResponse = await fetch(locationApiUrl);
                if (locationResponse.ok) {
                    const data = await locationResponse.json();
                    locationName = data.address.city || data.address.town || data.address.village || 'Nezn치m치';
                } else {
                    locationName = 'Nezn치m치 lokalita';
                }
            }
            
            const weather = {
                temp: weatherData.current.temperature_2m,
                humidity: weatherData.current.relative_humidity_2m,
                wind: weatherData.current.wind_speed_10m,
                rain_today: weatherData.current.precipitation,
                rain_yesterday: weatherData.daily.precipitation_sum[0]
            };

            const probability = calculateSwarmProbability(weather);
            return { weather, location: locationName, probability };
        }

        function calculateSwarmProbability(weather) {
            const scores = { month: 0, temp: 0, humidity: 0, wind: 0, rain: 0 };
            const currentMonth = new Date().getMonth();
            if (currentMonth >= 5 && currentMonth <= 7) scores.month = 1.0; else if (currentMonth === 4 || currentMonth === 8) scores.month = 0.5;
            if (weather.temp >= 23 && weather.temp <= 30) scores.temp = 1.0; else if (weather.temp > 19) scores.temp = 0.7; else scores.temp = 0.1;
            if (weather.humidity > 65) scores.humidity = 1.0; else if (weather.humidity > 55) scores.humidity = 0.4; else scores.humidity = 0.1;
            if (weather.wind < 10) scores.wind = 1.0; else if (weather.wind < 15) scores.wind = 0.5;
            if (weather.rain_yesterday > 0.5 && weather.rain_today < 0.2) scores.rain = 1.0; else if (weather.rain_yesterday > 0.1 && weather.rain_today < 0.5) scores.rain = 0.7; else scores.rain = 0.2;
            if (scores.month === 0) return 0;
            return ((scores.temp * 0.35) + (scores.humidity * 0.30) + (scores.rain * 0.20) + (scores.wind * 0.15)) * scores.month;
        }

        function updateUI(probability, weather, location) {
            probabilityCircle.style.backgroundColor = `hsl(${probability * 120}, 85%, 55%)`;
            let probText;
            if (probability > 0.8) probText = "Extr칠mn캩 vysok치 코ance";
            else if (probability > 0.6) probText = "Vysok치 코ance";
            else if (probability > 0.4) probText = "Mo쬹칠";
            else if (probability > 0.2) probText = "N칤zk치 코ance";
            else probText = "Velmi n칤zk치 코ance";
            statusMessage.textContent = `${probText} (${Math.round(probability * 100)}%)`;
            const currentMonth = new Date().getMonth();
            const parameters = [
                { key: 'location', label: 'Lokalita', value: location, rawValue: location },
                { key: 'month', label: 'M캩s칤c', value: new Date().toLocaleString('cs-CZ', { month: 'long' }), rawValue: currentMonth },
                { key: 'temp', label: 'Teplota', value: `${weather.temp.toFixed(1)} 춿C`, rawValue: weather.temp },
                { key: 'humidity', label: 'Vlhkost', value: `${weather.humidity.toFixed(0)} %`, rawValue: weather.humidity },
                { key: 'wind', label: 'V칤tr', value: `${weather.wind.toFixed(1)} km/h`, rawValue: weather.wind },
                { key: 'rain', label: 'D칠코콘 v캜era', value: `${weather.rain_yesterday.toFixed(1)} mm`, rawValue: weather.rain_yesterday }
            ];
            parametersGrid.innerHTML = parameters.map(p => createParameterTile(p.label, p.value, getStatus(p.key, p.rawValue), p.key)).join('');
        }

        function createParameterTile(label, value, status, key) {
            return `
                <div class="bg-gray-100 p-3 rounded-lg shadow-sm parameter-tile" data-param="${key}">
                    <div class="text-xs text-gray-500 pointer-events-none">${label}</div>
                    <div class="text-lg font-bold text-gray-900 pointer-events-none">${value}</div>
                    <div class="text-xs font-medium ${status.color} pointer-events-none">${status.text}</div>
                </div>`;
        }
        
        function getStatus(param, value) {
            const statuses = {
                month: [ { check: v => v >= 5 && v <= 7, text: 'Hlavn칤 sez칩na', color: 'text-green-600' }, { check: v => v === 4 || v === 8, text: 'Okraj sez칩ny', color: 'text-yellow-600' }, { check: v => true, text: 'Mimo sez칩nu', color: 'text-red-600' } ],
                temp: [ { check: v => v >= 23 && v <= 30, text: 'Ide치ln칤', color: 'text-green-600' }, { check: v => v > 19, text: 'Dobr치', color: 'text-yellow-600' }, { check: v => true, text: 'Nevhodn치', color: 'text-red-600' } ],
                humidity: [ { check: v => v > 65, text: 'Ide치ln칤', color: 'text-green-600' }, { check: v => v > 55, text: 'Dobr치', color: 'text-yellow-600' }, { check: v => true, text: 'N칤zk치', color: 'text-red-600' } ],
                wind: [ { check: v => v < 10, text: 'Ide치ln칤', color: 'text-green-600' }, { check: v => v < 15, text: 'M칤rn칳', color: 'text-yellow-600' }, { check: v => true, text: 'Siln칳', color: 'text-red-600' } ],
                rain: [ { check: v => v > 0.5, text: 'Ide치ln칤', color: 'text-green-600' }, { check: v => v > 0.1, text: 'OK', color: 'text-yellow-600' }, { check: v => true, text: 'Sucho', color: 'text-red-600' } ],
                location: [ { check: v => true, text: 'Zm캩nit polohu', color: 'text-blue-500' } ]
            };
            return statuses[param].find(s => s.check(value));
        }
    </script>

</body>
</html>
